/**
 * GOOGLE APPS SCRIPT - PRE-MATR√çCULA 2026
 * Liceo Bicentenario Polit√©cnico "Cesareo Aguirre Goyenechea"
 * VERSI√ìN FINAL - COMPATIBLE CON FORMULARIO HTML
 */

// CONFIGURACI√ìN
const SHEET_NAME = 'Matriculas2026';
const SPREADSHEET_ID = '1_sNkmhxNbsQBmRLoBAhUO7ijK2KSoVVPIYvOeVmWmXw';

/**
 * Funci√≥n principal que recibe datos del formulario
 */
function doPost(e) {
  try {
    Logger.log('=== INICIO DE SOLICITUD ===');
    Logger.log('Tipo de solicitud: POST');
    
    let data = {};
    
    // M√âTODO 1: Intentar leer como JSON
    if (e && e.postData && e.postData.contents) {
      Logger.log('M√©todo 1: Leyendo como JSON');
      try {
        data = JSON.parse(e.postData.contents);
        Logger.log('‚úÖ Datos JSON parseados correctamente');
      } catch (jsonError) {
        Logger.log('‚ö†Ô∏è No es JSON v√°lido: ' + jsonError);
      }
    }
    
    // M√âTODO 2: Leer como par√°metros de formulario
    if (e && e.parameter && Object.keys(data).length === 0) {
      Logger.log('M√©todo 2: Leyendo como par√°metros');
      data = e.parameter;
      Logger.log('‚úÖ Datos de par√°metros obtenidos');
    }
    
    // M√âTODO 3: Leer par√°metros individuales
    if (e && e.parameters && Object.keys(data).length === 0) {
      Logger.log('M√©todo 3: Leyendo par√°metros individuales');
      data = {};
      for (let key in e.parameters) {
        data[key] = e.parameters[key][0];
      }
      Logger.log('‚úÖ Par√°metros individuales procesados');
    }
    
    // Verificar que tenemos datos
    if (Object.keys(data).length === 0) {
      Logger.log('‚ùå ERROR: No se recibieron datos');
      throw new Error('No se recibieron datos del formulario');
    }
    
    Logger.log('üìä Total de campos recibidos: ' + Object.keys(data).length);
    Logger.log('Muestra de datos: ' + JSON.stringify(data).substring(0, 200));
    
    // Obtener la hoja
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName(SHEET_NAME);
    
    // Crear hoja si no existe
    if (!sheet) {
      Logger.log('‚ö†Ô∏è Hoja no existe, creando...');
      sheet = ss.insertSheet(SHEET_NAME);
      crearEncabezados(sheet);
      Logger.log('‚úÖ Hoja creada');
    }
    
    // Crear encabezados si la hoja est√° vac√≠a
    if (sheet.getLastRow() === 0) {
      Logger.log('‚ö†Ô∏è Hoja vac√≠a, creando encabezados...');
      crearEncabezados(sheet);
      Logger.log('‚úÖ Encabezados creados');
    }
    
    // Preparar datos en el orden correcto
    const timestamp = new Date();
    
    const rowData = [
      timestamp,                              // A - Timestamp
      '',                                     // B - numRegistro (f√≥rmula)
      data.fechaMatricula || '',              // C
      data.curso || '',                       // D
      data.cursoGestionPasada || '',          // E
      data.especialidad || '',                // F
      data.apellidoPaterno || '',             // G
      data.apellidoMaterno || '',             // H
      data.nombres || '',                     // I
      data.run || '',                         // J
      data.sexo || '',                        // K
      data.fechaNacimiento || '',             // L
      data.edad || '',                        // M
      data.lugarNacimiento || '',             // N
      data.pais || '',                        // O
      data.nacionalidad || '',                // P
      data.religion || '',                    // Q
      data.etnia || '',                       // R
      data.celularEstudiante || '',           // S
      data.correoEstudiante || '',            // T
      data.domicilioEstudiante || '',         // U
      data.nombreApoderadoTitular || '',      // V
      data.correoApoderadoTitular || '',      // W
      data.fonoApoderadoTitular || '',        // X
      data.nombreApoderadoSuplente || '',     // Y
      data.correoApoderadoSuplente || '',     // Z
      data.fonoApoderadoSuplente || '',       // AA
      data.profesionPadre || '',              // AB
      data.profesionMadre || '',              // AC
      data.profesionApoderado || '',          // AD
      data.personaConQuienVive || '',         // AE
      data.totalHijos || '',                  // AF
      data.lugarQueOcupa || '',               // AG
      data.personasEnCasa || '',              // AH
      data.tipoDomicilio || '',               // AI
      data.situacionEconomica || '',          // AJ
      data.subsidioUnicoFamiliar || '',       // AK
      data.beneficioJunaeb || '',             // AL
      data.chileSolidario || '',              // AM
      data.becaIndigena || '',                // AN
      data.cuidadosEspeciales || '',          // AO
      data.medicamentosContraindicados || '', // AP
      data.atencionSalud || '',               // AQ
      data.contactoEmergencia || '',          // AR
      data.telefonoEmergencia || '',          // AS
      data.procedenciaEscuela || '',          // AT
      data.cursoRepetido || ''                // AU
    ];
    
    Logger.log('üìù Preparando para agregar fila...');
    
    // Agregar fila
    sheet.appendRow(rowData);
    const lastRow = sheet.getLastRow();
    
    Logger.log('‚úÖ Fila agregada: ' + lastRow);
    
    // Agregar f√≥rmula en columna B
    sheet.getRange(lastRow, 2).setFormula('=SI(A' + lastRow + '="";"";FILA()-1)');
    
    // Formatear timestamp
    sheet.getRange(lastRow, 1).setNumberFormat('dd/mm/yyyy hh:mm:ss');
    
    Logger.log('‚úÖ Datos guardados exitosamente en fila: ' + lastRow);
    Logger.log('=== FIN DE SOLICITUD ===');
    
    // Respuesta exitosa
    return ContentService
      .createTextOutput(JSON.stringify({
        status: 'success',
        message: 'Datos guardados correctamente',
        row: lastRow,
        timestamp: timestamp.toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    Logger.log('‚ùå ERROR CR√çTICO: ' + error.toString());
    Logger.log('Stack trace: ' + error.stack);
    
    // Respuesta de error
    return ContentService
      .createTextOutput(JSON.stringify({
        status: 'error',
        message: error.toString(),
        details: error.stack
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Funci√≥n para crear encabezados
 */
function crearEncabezados(sheet) {
  const headers = [
    'Timestamp',                      // A
    'numRegistro',                    // B
    'fechaMatricula',                 // C
    'curso',                          // D
    'cursoGestionPasada',             // E
    'especialidad',                   // F
    'apellidoPaterno',                // G
    'apellidoMaterno',                // H
    'nombres',                        // I
    'run',                            // J
    'sexo',                           // K
    'fechaNacimiento',                // L
    'edad',                           // M
    'lugarNacimiento',                // N
    'pais',                           // O
    'nacionalidad',                   // P
    'religion',                       // Q
    'etnia',                          // R
    'celularEstudiante',              // S
    'correoEstudiante',               // T
    'domicilioEstudiante',            // U
    'nombreApoderadoTitular',         // V
    'correoApoderadoTitular',         // W
    'fonoApoderadoTitular',           // X
    'nombreApoderadoSuplente',        // Y
    'correoApoderadoSuplente',        // Z
    'fonoApoderadoSuplente',          // AA
    'profesionPadre',                 // AB
    'profesionMadre',                 // AC
    'profesionApoderado',             // AD
    'personaConQuienVive',            // AE
    'totalHijos',                     // AF
    'lugarQueOcupa',                  // AG
    'personasEnCasa',                 // AH
    'tipoDomicilio',                  // AI
    'situacionEconomica',             // AJ
    'subsidioUnicoFamiliar',          // AK
    'beneficioJunaeb',                // AL
    'chileSolidario',                 // AM
    'becaIndigena',                   // AN
    'cuidadosEspeciales',             // AO
    'medicamentosContraindicados',    // AP
    'atencionSalud',                  // AQ
    'contactoEmergencia',             // AR
    'telefonoEmergencia',             // AS
    'procedenciaEscuela',             // AT
    'cursoRepetido'                   // AU
  ];
  
  // Agregar encabezados
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  
  // Formatear encabezados
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#4a86e8');
  headerRange.setFontColor('#ffffff');
  headerRange.setHorizontalAlignment('center');
  
  // Congelar primera fila
  sheet.setFrozenRows(1);
  
  // Ajustar columnas
  sheet.autoResizeColumns(1, headers.length);
  
  Logger.log('‚úÖ Encabezados creados y formateados');
}

/**
 * Funci√≥n de prueba GET
 */
function doGet(e) {
  return ContentService
    .createTextOutput('‚úÖ Servicio de Pre-Matr√≠cula 2026 - Activo y Funcionando\n\nVersi√≥n: 1.0\nEstado: Operativo')
    .setMimeType(ContentService.MimeType.TEXT);
}

/**
 * Funci√≥n de prueba para verificar la configuraci√≥n
 */
function testConnection() {
  try {
    Logger.log('=== TEST DE CONEXI√ìN ===');
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    Logger.log('‚úÖ Conexi√≥n exitosa con: ' + ss.getName());
    Logger.log('üìã URL: ' + ss.getUrl());
    
    let sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) {
      Logger.log('‚ö†Ô∏è La hoja "' + SHEET_NAME + '" no existe');
      Logger.log('üí° Se crear√° autom√°ticamente al recibir el primer env√≠o');
    } else {
      Logger.log('‚úÖ Hoja encontrada: ' + SHEET_NAME);
      Logger.log('üìä Filas actuales: ' + sheet.getLastRow());
      Logger.log('üìä Columnas: ' + sheet.getLastColumn());
    }
    
    Logger.log('=== TEST COMPLETADO ===');
    return true;
  } catch (error) {
    Logger.log('‚ùå ERROR EN TEST: ' + error.toString());
    return false;
  }
}

/**
 * Funci√≥n para simular un env√≠o de prueba
 */
function testSubmit() {
  Logger.log('=== PRUEBA DE ENV√çO ===');
  
  const testData = {
    parameter: {
      fechaMatricula: '2026-01-15',
      curso: '1¬∞ Medio',
      apellidoPaterno: 'P√©rez',
      apellidoMaterno: 'Gonz√°lez',
      nombres: 'Juan Carlos',
      run: '12345678-9',
      sexo: 'Masculino',
      fechaNacimiento: '2010-05-20',
      edad: '15',
      contactoEmergencia: 'Mar√≠a P√©rez',
      telefonoEmergencia: '+56912345678',
      subsidioUnicoFamiliar: 'No',
      beneficioJunaeb: 'S√≠',
      chileSolidario: 'No',
      becaIndigena: 'No'
    }
  };
  
  const result = doPost(testData);
  Logger.log('Resultado: ' + result.getContent());
  Logger.log('=== PRUEBA COMPLETADA ===');
}
